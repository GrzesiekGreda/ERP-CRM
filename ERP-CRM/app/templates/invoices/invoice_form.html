{% extends "base.html" %}

{% block title %}Nowa faktura - ERP/CRM{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-file-earmark-plus me-2"></i>Nowa faktura</h2>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="invoiceForm">
                    <div class="mb-3">
                        <label for="customer_id" class="form-label">Kontrahent <span class="text-danger">*</span></label>
                        <select class="form-select" id="customer_id" name="customer_id" required>
                            <option value="">Wybierz kontrahenta...</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }} {% if customer.tax_id %}(NIP: {{ customer.tax_id }}){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Pozycje faktury <span class="text-danger">*</span></label>
                        <div id="invoice-items">
                            <div class="invoice-item border rounded p-3 mb-3">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label">Produkt/Usługa</label>
                                        <select class="form-select product-select" name="product_id[]" onchange="fillProductData(this)">
                                            <option value="">Wybierz produkt lub wpisz ręcznie...</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" 
                                                    data-description="{{ product.name }}"
                                                    data-unit="{{ product.unit }}"
                                                    data-price="{{ product.price }}">
                                                {{ product.name }} ({{ product.sku }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-8 mb-2">
                                        <label class="form-label">Opis <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control description-input" name="description[]" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label">Ilość</label>
                                        <input type="number" class="form-control quantity-input" name="quantity[]" value="1" step="0.01" min="0.01" required onchange="calculateTotals()">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label">Jednostka</label>
                                        <select class="form-select unit-input" name="unit[]">
                                            <option value="szt.">szt.</option>
                                            <option value="kg">kg</option>
                                            <option value="m">m</option>
                                            <option value="m2">m</option>
                                            <option value="m3">m</option>
                                            <option value="l">l</option>
                                            <option value="godz.">godz.</option>
                                            <option value="usł.">usł.</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label class="form-label">Cena netto (PLN)</label>
                                        <input type="number" class="form-control price-input" name="unit_price[]" step="0.01" min="0" required onchange="calculateTotals()">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label">VAT (%)</label>
                                        <select class="form-select vat-input" name="vat_rate[]" onchange="calculateTotals()">
                                            <option value="23" selected>23%</option>
                                            <option value="8">8%</option>
                                            <option value="5">5%</option>
                                            <option value="0">0%</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label class="form-label">Wartość brutto</label>
                                        <input type="text" class="form-control gross-amount" readonly>
                                    </div>
                                    <div class="col-md-1 mb-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addItem()">
                            <i class="bi bi-plus-circle me-1"></i>Dodaj pozycję
                        </button>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Uwagi</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('invoices.invoice_list') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-1"></i>Anuluj
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Utwórz fakturę
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Podsumowanie</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td>Wartość netto:</td>
                        <td class="text-end"><strong id="total-net">0.00 PLN</strong></td>
                    </tr>
                    <tr>
                        <td>VAT:</td>
                        <td class="text-end"><strong id="total-vat">0.00 PLN</strong></td>
                    </tr>
                    <tr class="table-primary">
                        <td><strong>Wartość brutto:</strong></td>
                        <td class="text-end"><strong id="total-gross">0.00 PLN</strong></td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="bi bi-info-circle me-2"></i>Informacja</h6>
                <p class="small mb-0">Numer faktury zostanie automatycznie nadany w formacie: INV-YYYYMMDD-XXXX</p>
                <p class="small mb-0 mt-2">Domyślny termin płatności: 30 dni od daty wystawienia</p>
            </div>
        </div>
    </div>
</div>

<script>
function fillProductData(select) {
    const item = select.closest('.invoice-item');
    const option = select.options[select.selectedIndex];
    
    if (option.value) {
        item.querySelector('.description-input').value = option.dataset.description || '';
        item.querySelector('.unit-input').value = option.dataset.unit || 'szt.';
        item.querySelector('.price-input').value = option.dataset.price || '';
        calculateTotals();
    }
}

function addItem() {
    const container = document.getElementById('invoice-items');
    const firstItem = container.querySelector('.invoice-item');
    const newItem = firstItem.cloneNode(true);
    
    // Clear values
    newItem.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        if (input.classList.contains('quantity-input')) {
            input.value = '1';
        } else if (input.classList.contains('gross-amount')) {
            input.value = '';
        } else {
            input.value = '';
        }
    });
    newItem.querySelector('.product-select').selectedIndex = 0;
    newItem.querySelector('.vat-input').value = '23';
    
    container.appendChild(newItem);
    calculateTotals();
}

function removeItem(button) {
    const container = document.getElementById('invoice-items');
    if (container.querySelectorAll('.invoice-item').length > 1) {
        button.closest('.invoice-item').remove();
        calculateTotals();
    } else {
        alert('Faktura musi zawierać przynajmniej jedną pozycję');
    }
}

function calculateTotals() {
    let totalNet = 0;
    let totalVat = 0;
    let totalGross = 0;
    
    document.querySelectorAll('.invoice-item').forEach(item => {
        const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(item.querySelector('.price-input').value) || 0;
        const vatRate = parseInt(item.querySelector('.vat-input').value) || 0;
        
        const net = quantity * price;
        const vat = net * (vatRate / 100);
        const gross = net + vat;
        
        item.querySelector('.gross-amount').value = gross.toFixed(2) + ' PLN';
        
        totalNet += net;
        totalVat += vat;
        totalGross += gross;
    });
    
    document.getElementById('total-net').textContent = totalNet.toFixed(2) + ' PLN';
    document.getElementById('total-vat').textContent = totalVat.toFixed(2) + ' PLN';
    document.getElementById('total-gross').textContent = totalGross.toFixed(2) + ' PLN';
}

// Initialize calculations on page load
document.addEventListener('DOMContentLoaded', function() {
    calculateTotals();
});
</script>
{% endblock %}
